<div class="container">
  <h1>â• æ–°å¢ä¿é¤Š/ç¶­ä¿®ç´€éŒ„</h1>
  <form action="/dashboard/reports/add" method="POST" class="form">
    <label for="m_id">è¨­å‚™ç·¨è™Ÿ</label>
    <input type="text" id="m_id" name="m_id" required>
    <span id="m_id_check" style="color:red;"></span>

    <label for="log_type">ä¿é¤Šé¡å‹</label>
    <select name="log_type" id="log_type" required>
      <option value="æ—¥ä¿é¤Š">æ—¥ä¿é¤Š</option>
      <option value="å‘¨ä¿é¤Š">å‘¨ä¿é¤Š</option>
      <option value="å­£ä¿é¤Š">å­£ä¿é¤Š</option>
      <option value="å¹´ä¿">å¹´ä¿</option>
      <option value="æ•…éšœç¶­ä¿®">æ•…éšœç¶­ä¿®</option>
    </select>

    <label>æª¢æŸ¥é …ç›®ï¼š</label>
    <table border="1" cellpadding="8" cellspacing="0">
      <thead>
        <tr>
          <th>é …ç›®</th>
          <th>å‹¾é¸</th>
          <th>ç‹€æ…‹</th>
        </tr>
      </thead>
      <tbody id="check-items-body">
        <!-- JS å‹•æ…‹æ’å…¥ -->
      </tbody>
    </table>

    <label for="log_desc">ä¿é¤Š/ç¶­ä¿®å…§å®¹</label>
    <textarea name="log_desc" rows="4" required></textarea>

    <button type="submit" class="btn">æäº¤ç´€éŒ„</button>
  </form>
</div>

<script>
  const mIdInput = document.getElementById('m_id');
  const checkMsg = document.getElementById('m_id_check');
  let timer;

  mIdInput.addEventListener('input', () => {
    clearTimeout(timer);
    const mId = mIdInput.value.trim();
    if (mId === '') {
      checkMsg.textContent = '';
      return;
    }
    checkMsg.style.color = '#555';
    checkMsg.textContent = 'ğŸ” æª¢æŸ¥ä¸­...';
    timer = setTimeout(async () => {
      try {
        const response = await fetch(`/dashboard/check-mid/${encodeURIComponent(mId)}`);
        const data = await response.json();
        if (data.exists) {
          checkMsg.style.color = 'green';
          checkMsg.textContent = 'âœ”ï¸ è¨­å‚™å­˜åœ¨';
        } else {
          checkMsg.style.color = 'red';
          checkMsg.textContent = 'âŒ æ‰¾ä¸åˆ°è©²è¨­å‚™';
        }
      } catch (error) {
        console.error('è¨­å‚™æª¢æŸ¥å¤±æ•—:', error);
        checkMsg.style.color = 'orange';
        checkMsg.textContent = 'âš ï¸ ç„¡æ³•æª¢æŸ¥è¨­å‚™';
      }
    }, 500);
  });

  document.querySelector('form').addEventListener('submit', function (e) {
    const submitButton = this.querySelector('button[type="submit"]');
    submitButton.disabled = true;
    submitButton.textContent = 'é€å‡ºä¸­...';
  });

  const checkItemsMap = {
    'æ—¥ä¿é¤Š': ['åŠ æ½¤æ»‘æ²¹', 'æ©Ÿæ¢°æ¸…æ½”', 'æŒ‡ç¤ºç‡ˆ'],
    'å‘¨ä¿é¤Š': ['åŠ æ½¤æ»‘æ²¹', 'æ©Ÿæ¢°æ¸…æ½”', 'é›»è·¯æ­£å¸¸', 'æŒ‡ç¤ºç‡ˆ'],
    'å­£ä¿é¤Š': ['åŠ æ½¤æ»‘æ²¹', 'æ©Ÿæ¢°æ¸…æ½”', 'æŒ‡ç¤ºç‡ˆ', 'æ²¹å£“æ­£å¸¸', 'å™ªéŸ³æ­£å¸¸'],
    'å¹´ä¿': ['åŠ æ½¤æ»‘æ²¹', 'æ©Ÿæ¢°æ¸…æ½”', 'æŒ‡ç¤ºç‡ˆ', 'æ²¹å£“æ­£å¸¸', 'å™ªéŸ³æ­£å¸¸', 'åºŠå°é–“éš™', 'èºæ¡¿é–“éš™', 'è»¸æ‰¿é–“éš™'],
    'æ•…éšœç¶­ä¿®': ['é›»è·¯æ­£å¸¸', 'æ²¹å£“æ­£å¸¸', 'å™ªéŸ³æ­£å¸¸']
  };

  const itemValueMap = {
    'åŠ æ½¤æ»‘æ²¹': 1,
    'æ©Ÿæ¢°æ¸…æ½”': 2,
    'æŒ‡ç¤ºç‡ˆ': 4,
    'é›»è·¯æ­£å¸¸': 8,
    'æ²¹å£“æ­£å¸¸': 16,
    'å™ªéŸ³æ­£å¸¸': 32,
    'åºŠå°é–“éš™': 64,
    'èºæ¡¿é–“éš™': 128,
    'è»¸æ‰¿é–“éš™': 256
  };

  const checkItemsBody = document.getElementById('check-items-body');
  const logTypeSelect = document.getElementById('log_type');

  function renderCheckItems(type) {
    const allItems = Object.keys(itemValueMap);
    const requiredItems = new Set(checkItemsMap[type] || []);
    checkItemsBody.innerHTML = '';

    allItems.forEach(label => {
      const value = itemValueMap[label];
      const isRequired = requiredItems.has(label);

      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="label">${label}</td>
        <td class="checkbox-wrapper">
          <input type="checkbox" name="log_flags[]" value="${value}" class="item-checkbox" ${isRequired ? '' : 'disabled'}>
        </td>
        <td>
          <label><input type="radio" name="flag_status_${value}" value="æ­£å¸¸" ${isRequired ? '' : 'disabled'}> æ­£å¸¸</label>
          <label><input type="radio" name="flag_status_${value}" value="ä¸æ­£å¸¸" ${isRequired ? '' : 'disabled'}> ä¸æ­£å¸¸</label>
        </td>
      `;
      checkItemsBody.appendChild(row);
    });

    updateColorHighlighting();
  }

  function updateColorHighlighting() {
    const rows = checkItemsBody.querySelectorAll('tr');
    rows.forEach(row => {
      const checkbox = row.querySelector('.item-checkbox');
      const radios = row.querySelectorAll('input[type="radio"]');
      const labelTd = row.querySelector('.label');

      radios.forEach(radio => {
        radio.addEventListener('change', () => {
          if (!checkbox.checked) return;
          if (radio.value === 'æ­£å¸¸' && radio.checked) {
            labelTd.style.color = 'green';
          } else if (radio.value === 'ä¸æ­£å¸¸' && radio.checked) {
            labelTd.style.color = 'red';
          }
        });
      });

      checkbox.addEventListener('change', () => {
        const enabled = checkbox.checked;
        radios.forEach(r => r.disabled = !enabled);
        if (!enabled) labelTd.style.color = '#000';
      });
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    renderCheckItems(logTypeSelect.value);
    logTypeSelect.addEventListener('change', () => {
      renderCheckItems(logTypeSelect.value);
    });
  });
</script>

<style>
  .checkbox-wrapper {
    position: relative;
    width: 24px;
    height: 24px;
  }

  .checkbox-wrapper input[type="checkbox"] {
    appearance: none;
    -webkit-appearance: none;
    width: 100%;
    height: 100%;
    border: 2px solid #999;
    cursor: pointer;
    font-size: 20px;
    text-align: center;
    position: relative;
    background-color: white;
  }

  .checkbox-wrapper input[type="checkbox"]::before {
    content: "âœ–";
    position: absolute;
    top: -2px;
    left: 3px;
    color: red;
    font-size: 18px;
  }

  .checkbox-wrapper input[type="checkbox"]:checked::before {
    content: "âœ”";
    color: green;
  }

  .label {
    transition: color 0.3s;
    font-weight: bold;
  }

  .container {
    max-width: 700px;
    margin: auto;
    padding: 2rem;
  }

  .form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  label {
    font-weight: bold;
  }

  input, select, textarea {
    padding: 0.5rem;
    font-size: 1rem;
  }

  .btn {
    padding: 0.5rem 1rem;
    background-color: #28a745;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
</style>
